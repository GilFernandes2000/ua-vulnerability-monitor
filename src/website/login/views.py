from django.shortcuts import render, redirect
from django.contrib.auth import authenticate, login, logout
from sqlalchemy import *
from sqlalchemy import create_engine, MetaData, Table, Column, Integer, String, ForeignKey
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker, relationship

# Create your views here.

def loginUser(request):
    if request.user.is_authenticated:
        return redirect('/dashboard/')
    else:
        txt = request.POST.get('loginButton', None)
        if txt != None:
            y = txt.split("\t")
            email = y[0]
            password = y[1]
            if email != '' and password != '':
                engine = create_engine('mariadb+mariadbconnector://username:password@db:3306/project', echo=False)
                cnn = engine.connect()

                metadata = MetaData()
                users = Table('Users', metadata, autoload = True, autoload_with=engine)

                select = users.select().where(users.c.email == email)
                result = cnn.execute(select)
                info = result.fetchall()
                if info != []:
                    username = info[0][0]
                    user = authenticate(request, username = username, password = password)
                    if user != None:
                        login(request, user)
                        return redirect('/dashboard/')
        return render(request, 'login.html')
        
def logoutUser(request):
    if request.user.is_authenticated:
        logout(request)
    return redirect('/home/')

