from celery.utils.log import get_task_logger
import celery
from .celery import app
from subprocess import PIPE
import subprocess
import send_email

logger = get_task_logger(__name__)

@app.task()
def analiseOne(domainName):
    logger.info("Celery     : Analisys started")
    cmd = f'docker run --rm --net deploy_backend analise-run -o {domainName}'
    r = subprocess.Popen(cmd, shell=True, stderr=PIPE, universal_newlines=True)
    err = r.communicate()
    print(f'err : {err}')
    logger.info("Celery     : Analisys ended")
    
    send_email.main(domainName)
    
@app.task()
def analiseAll(domainName):
    logger.info("Celery     : Analisys started")
    cmd = f'docker run --rm --net backend analise-run -d {domainName}'
    r = subprocess.Popen(cmd, shell=True, stderr=PIPE, universal_newlines=True)
    err = r.communicate()
    print(f'err : {err}')
    logger.info("Celery     : Analisys ended")
    send_email.main(domainName)
