USE IP_CVE_Bank;
GO

/*Function to find all CVE of a machine with machine id*/
CREATE FUNCTION Project.getMachineCVEList(@id as int)
RETURNS table
AS
RETURN(select m.IP_address,c.CVE_id,c.CVSS 
	   from Project.Machine m JOIN Project.Machine_Vuln v ON m.id=v.FK_Machine JOIN Project.CVE c ON v.FK_CVE=c.CVE_id
	   where m.id=@id)
go

--select * from Project.getMachineCVEList('4')
--drop function Project.getMachineCVEList

/*Function to find the Machines affected by a CVE with CVE id*/
CREATE FUNCTION Project.getCVEMachines(@cve_id as VARCHAR(30))
RETURNS table
AS
RETURN(select c.CVE_id,i.IP_address,i.Machine_User,i.Machine_Owner
	   from Project.CVE AS c JOIN Project.Machine_Vuln AS m ON m.FK_CVE=c.CVE_id JOIN Project.Machine i ON m.FK_Machine=i.id
	   where m.FK_CVE=@cve_id)
go

--select * from Project.getCVEMachines('CVE-2021-43243')
--drop function Project.getCVEMachines

/*Function to find the CVSS of a CVE*/
CREATE FUNCTION Project.getCVE_CVSS(@cve_id as VARCHAR(30))
RETURNS table
AS
RETURN(select c.CVSS
	   from Project.CVE AS c
	   where CVE_id=@cve_id)
go

--select * from Project.getCVE_CVSS('CVE-2021-43907')
--drop function Project.getCVE_CVSS

/*Function to find the Department of a Machine with machine ID*/
CREATE FUNCTION Project.getMachineDepartment(@mach_id as int)
RETURNS table
AS
RETURN(select m.id as MachineID,m.IP_address,d.id as DepartmentID,d.name as DepartmentName from  Project.Machine m JOIN Project.Department d ON d.id=m.FK_Department 
	   where m.id=@mach_id)
go

--select * from Project.getMachineDepartment('1')
--select * from Project.getMachineDepartment('4')
--drop function Project.getMachineDepartment